"use strict";var LinearEquation=function(){function LinearEquation(x1,y1,x2,y2){this.slope=(y2-y1)/(x2-x1);this.inter=y1-this.slope*x1;this.x1=x1;this.y1=y1;this.x2=x2;this.y2=y2}LinearEquation.prototype.eval=function(z){return this.slope*z+this.inter};return LinearEquation}();var SVGCandleStick=function(){function SVGCandleStick(cht,cnd,CndIdx){this.candleBody=null;this.candleWick=null;this.SingleCandleLookUp={1:"M",2:"M",3:"S",4:"S",5:"D",6:"D",7:"D"};this.SingleCandleText=null;this.SingleCandleTextCode=null;this.SlopedTrendLine=null;this.HorizontalTrendLine=null;this.SlopedTrendLineData=null;this.HorizontalTrendLineData=null;this.DoubleCandleAnalysis=null;this.DoubleCandleAnalysisCode=null;this.PriceTransformedCandle=cnd;this.rootChart=cht;this.RawCandle={o:cnd.o,h:cnd.h,l:cnd.l,c:cnd.c};this.performCandleTransformation();this.CndIdx=CndIdx;this.candleBody=this.buildCandleBody();this.candleWick=this.buildCandleWick();this.candleGroup=document.createElementNS(SVGCandleChart.SVG_NS,"g");if(this.candleWick){this.candleGroup.appendChild(this.candleWick)}else{console.error("this.candleWick === null")}if(this.candleBody){this.candleGroup.appendChild(this.candleBody)}else{console.error("this.candleBody === null")}cht.getSVGCandlesDom().appendChild(this.candleGroup)}SVGCandleStick.prototype.buildCandleBody=function(){var cb;var createdNewCandle=false;if(this.candleBody===null){cb=document.createElementNS(SVGCandleChart.SVG_NS,"rect");createdNewCandle=true}else{cb=this.candleBody}cb.setAttributeNS(null,"width",this.rootChart.getCandleWidth().toString());if(this.PriceTransformedCandle.o>this.PriceTransformedCandle.c){cb.setAttributeNS(null,"height",(this.PriceTransformedCandle.o-this.PriceTransformedCandle.c).toString()+"px");cb.setAttributeNS(null,"y",this.PriceTransformedCandle.c.toString()+"px");cb.setAttributeNS(null,"fill","#228B22")}else if(this.PriceTransformedCandle.o<this.PriceTransformedCandle.c){cb.setAttributeNS(null,"height",(this.PriceTransformedCandle.c-this.PriceTransformedCandle.o).toString()+"px");cb.setAttributeNS(null,"y",this.PriceTransformedCandle.o.toString()+"px");cb.setAttributeNS(null,"fill","#E62020")}else{cb.setAttributeNS(null,"height","1");cb.setAttributeNS(null,"y",this.PriceTransformedCandle.o.toString()+"px")}cb.setAttributeNS(null,"x",(this.CndIdx*this.rootChart.getCandleWidth()).toString()+"px");cb.setAttributeNS(null,"shape-rendering","geometricPrecision");if(createdNewCandle){return cb}else{return null}};SVGCandleStick.prototype.buildCandleWick=function(){var cw;var createdNewWick=false;if(this.candleWick===null){cw=document.createElementNS(SVGCandleChart.SVG_NS,"line");createdNewWick=true}else{cw=this.candleWick}cw.setAttributeNS(null,"x1",(this.CndIdx*this.rootChart.getCandleWidth()+this.rootChart.getCandleWidth()/2).toString()+"px");cw.setAttributeNS(null,"y1",this.PriceTransformedCandle.h.toString());cw.setAttributeNS(null,"x2",(this.CndIdx*this.rootChart.getCandleWidth()+this.rootChart.getCandleWidth()/2).toString()+"px");cw.setAttributeNS(null,"y2",this.PriceTransformedCandle.l.toString());cw.setAttributeNS(null,"stroke-width","1");cw.setAttributeNS(null,"stroke","black");cw.setAttributeNS(null,"shape-rendering","geometricPrecision");if(createdNewWick){return cw}else{return null}};SVGCandleStick.prototype.tryUpdate=function(latestCandle){if(latestCandle.s===this.PriceTransformedCandle.s){if(latestCandle.o===this.RawCandle.o&&latestCandle.h===this.RawCandle.h&&latestCandle.l===this.RawCandle.l&&latestCandle.c===this.RawCandle.c){return true}this.PriceTransformedCandle=latestCandle;this.RawCandle={o:latestCandle.o,h:latestCandle.h,l:latestCandle.l,c:latestCandle.c};this.performCandleTransformation();this.buildCandleBody();this.buildCandleWick();return true}else{return false}};SVGCandleStick.prototype.performCandleTransformation=function(){this.PriceTransformedCandle.o=this.rootChart.getPriceTransformation().eval(this.PriceTransformedCandle.o);this.PriceTransformedCandle.h=this.rootChart.getPriceTransformation().eval(this.PriceTransformedCandle.h);this.PriceTransformedCandle.l=this.rootChart.getPriceTransformation().eval(this.PriceTransformedCandle.l);this.PriceTransformedCandle.c=this.rootChart.getPriceTransformation().eval(this.PriceTransformedCandle.c)};SVGCandleStick.prototype.shiftLeft=function(){this.CndIdx-=1;this.forceUpdate()};SVGCandleStick.prototype.putSingleCandleAnalysis=function(id){var newlyCreatedCandle=true;console.log("fdsa");switch(id){case 0:break;default:this.SingleCandleTextCode=id;if(this.SingleCandleText===null){this.SingleCandleText=document.createElementNS(SVGCandleChart.SVG_NS,"text")}else{newlyCreatedCandle=false}this.SingleCandleText.setAttributeNS(null,"x",(this.CndIdx*this.rootChart.getCandleWidth()).toString());this.SingleCandleText.setAttributeNS(null,"y",(this.PriceTransformedCandle.l+1).toString());this.SingleCandleText.setAttributeNS(null,"font-size",(this.rootChart.getCandleWidth()*1.6).toString()+"px");this.SingleCandleText.setAttributeNS(null,"dominant-baseline","hanging");this.SingleCandleText.setAttributeNS(null,"font-family","monospace");this.SingleCandleText.setAttributeNS(null,"text-anchore","middle");this.SingleCandleText.innerHTML=this.SingleCandleLookUp[id];if(newlyCreatedCandle){this.candleGroup.appendChild(this.SingleCandleText)}}};SVGCandleStick.prototype.putDoubleCandleAnalysis=function(id){var newlyCreatedCandle=true;switch(id){case 0:break;default:this.DoubleCandleAnalysisCode=id;if(this.DoubleCandleAnalysis===null){this.DoubleCandleAnalysis=document.createElementNS(SVGCandleChart.SVG_NS,"rect")}else{newlyCreatedCandle=false}this.DoubleCandleAnalysis.setAttributeNS(null,"x",(this.CndIdx*this.rootChart.getCandleWidth()-this.rootChart.getCandleWidth()).toString());this.DoubleCandleAnalysis.setAttributeNS(null,"y",this.PriceTransformedCandle.h.toString());this.DoubleCandleAnalysis.setAttributeNS(null,"width",(this.rootChart.getCandleWidth()*2).toString());this.DoubleCandleAnalysis.setAttributeNS(null,"height",(this.PriceTransformedCandle.l-this.PriceTransformedCandle.h).toString());this.DoubleCandleAnalysis.setAttributeNS(null,"stroke-width","1");this.DoubleCandleAnalysis.setAttributeNS(null,"stroke","black");this.DoubleCandleAnalysis.setAttributeNS(null,"shape-rendering","geometricPrecision");this.DoubleCandleAnalysis.setAttributeNS(null,"fill","blue");this.DoubleCandleAnalysis.setAttributeNS(null,"fill-opacity","0.3");if(newlyCreatedCandle){this.candleGroup.appendChild(this.DoubleCandleAnalysis)}}};SVGCandleStick.prototype.putSlopedTrendLine=function(tnd){this.SlopedTrendLineData=tnd;var newlyCreatedCandle=true;switch(tnd.d){case 0:case 2:if(this.SlopedTrendLine===null){this.SlopedTrendLine=document.createElementNS(SVGCandleChart.SVG_NS,"line")}else{newlyCreatedCandle=false}this.SlopedTrendLine.setAttributeNS(null,"x1",(this.CndIdx*this.rootChart.getCandleWidth()+this.rootChart.getCandleWidth()/2).toString());this.SlopedTrendLine.setAttributeNS(null,"y1",this.PriceTransformedCandle.l.toString());this.SlopedTrendLine.setAttributeNS(null,"x2",(this.rootChart.CandleDomReferences[tnd.s].CndIdx*this.rootChart.getCandleWidth()+this.rootChart.getCandleWidth()/2).toString());this.SlopedTrendLine.setAttributeNS(null,"y2",this.rootChart.CandleDomReferences[tnd.s].PriceTransformedCandle.l.toString());this.SlopedTrendLine.setAttributeNS(null,"shape-rendering","geometricPrecision");this.SlopedTrendLine.setAttributeNS(null,"stroke-width","2");this.SlopedTrendLine.setAttributeNS(null,"stroke","#FE4EDA");if(newlyCreatedCandle){this.candleGroup.appendChild(this.SlopedTrendLine)}break;case 1:case 3:if(this.SlopedTrendLine===null){this.SlopedTrendLine=document.createElementNS(SVGCandleChart.SVG_NS,"line")}else{newlyCreatedCandle=false}this.SlopedTrendLine.setAttributeNS(null,"x1",(this.CndIdx*this.rootChart.getCandleWidth()+this.rootChart.getCandleWidth()/2).toString());this.SlopedTrendLine.setAttributeNS(null,"y1",this.PriceTransformedCandle.h.toString());this.SlopedTrendLine.setAttributeNS(null,"x2",(this.rootChart.CandleDomReferences[tnd.s].CndIdx*this.rootChart.getCandleWidth()+this.rootChart.getCandleWidth()/2).toString());this.SlopedTrendLine.setAttributeNS(null,"y2",this.rootChart.CandleDomReferences[tnd.s].PriceTransformedCandle.h.toString());this.SlopedTrendLine.setAttributeNS(null,"shape-rendering","geometricPrecision");this.SlopedTrendLine.setAttributeNS(null,"stroke-width","2");this.SlopedTrendLine.setAttributeNS(null,"stroke","#FE4EDA");if(newlyCreatedCandle){this.candleGroup.appendChild(this.SlopedTrendLine)}break}};SVGCandleStick.prototype.putHorizontalTrendLine=function(tnd){this.HorizontalTrendLineData=tnd;var newlyCreatedCandle=true;switch(tnd.d){case 0:case 2:if(this.HorizontalTrendLine==null){this.HorizontalTrendLine=document.createElementNS(SVGCandleChart.SVG_NS,"line")}else{newlyCreatedCandle=false}this.HorizontalTrendLine.setAttributeNS(null,"x1",(this.CndIdx*this.rootChart.getCandleWidth()+this.rootChart.getCandleWidth()/2).toString());this.HorizontalTrendLine.setAttributeNS(null,"y1",this.PriceTransformedCandle.l.toString());this.HorizontalTrendLine.setAttributeNS(null,"x2",(this.rootChart.CandleDomReferences[tnd.s].CndIdx*this.rootChart.getCandleWidth()+this.rootChart.getCandleWidth()/2).toString());this.HorizontalTrendLine.setAttributeNS(null,"y2",this.PriceTransformedCandle.l.toString());this.HorizontalTrendLine.setAttributeNS(null,"shape-rendering","geometricPrecision");this.HorizontalTrendLine.setAttributeNS(null,"stroke-width","1");this.HorizontalTrendLine.setAttributeNS(null,"stroke","purple");if(newlyCreatedCandle){this.candleGroup.appendChild(this.HorizontalTrendLine)}break;case 1:case 3:if(this.HorizontalTrendLine===null){this.HorizontalTrendLine=document.createElementNS(SVGCandleChart.SVG_NS,"line")}else{newlyCreatedCandle=false}this.HorizontalTrendLine.setAttributeNS(null,"x1",(this.CndIdx*this.rootChart.getCandleWidth()+this.rootChart.getCandleWidth()/2).toString());this.HorizontalTrendLine.setAttributeNS(null,"y1",this.PriceTransformedCandle.h.toString());this.HorizontalTrendLine.setAttributeNS(null,"x2",(this.rootChart.CandleDomReferences[tnd.s].CndIdx*this.rootChart.getCandleWidth()+this.rootChart.getCandleWidth()/2).toString());this.HorizontalTrendLine.setAttributeNS(null,"y2",this.PriceTransformedCandle.h.toString());this.HorizontalTrendLine.setAttributeNS(null,"shape-rendering","geometricPrecision");this.HorizontalTrendLine.setAttributeNS(null,"stroke-width","1");this.HorizontalTrendLine.setAttributeNS(null,"stroke","black");if(newlyCreatedCandle){this.candleGroup.appendChild(this.HorizontalTrendLine)}break}};SVGCandleStick.prototype.forceUpdate=function(){this.PriceTransformedCandle.o=this.RawCandle.o;this.PriceTransformedCandle.h=this.RawCandle.h;this.PriceTransformedCandle.l=this.RawCandle.l;this.PriceTransformedCandle.c=this.RawCandle.c;this.performCandleTransformation();if(this.CndIdx>=-1){this.buildCandleBody();this.buildCandleWick();if(this.SlopedTrendLineData&&this.SlopedTrendLine){this.putSlopedTrendLine(this.SlopedTrendLineData)}if(this.HorizontalTrendLineData&&this.HorizontalTrendLine){this.putHorizontalTrendLine(this.HorizontalTrendLineData)}if(this.SingleCandleTextCode&&this.SingleCandleText){this.putSingleCandleAnalysis(this.SingleCandleTextCode)}if(this.DoubleCandleAnalysis&&this.DoubleCandleAnalysisCode){this.putDoubleCandleAnalysis(this.DoubleCandleAnalysisCode)}}};return SVGCandleStick}();var SVGCandleChart=function(){function SVGCandleChart(svgIndex,exchange,security){this.SERVER_IP="ws://161.35.136.101:7681";this.PriceTransformation=new LinearEquation(0,0,0,0);this.PixelTransformation=new LinearEquation(0,0,0,0);this.ChartStyleNumTicks=20;this.TotalCandlesServerReceived=0;this.WantedNumberOfCandles=200;this.CandleWidth=10;this.CandleDomReferences=[];this.TickPriceDomReferences=[];this.InputExchange="";this.InputSecurity="";this.SVGLastPriceBox=null;this.NumberOfSlopedTrendsDrawn=0;this.NumberOfHorizontalTrendsDrawn=0;this.NumberOfCandlePatternsDrawn=0;this.InputExchange=exchange;this.InputSecurity=security;var SvgCandleRootTop=document.getElementsByTagNameNS(SVGCandleChart.SVG_NS,"svg")[svgIndex];this.SvgCandleRoot=SvgCandleRootTop.children[0];this.SvgYAxisRoot=SvgCandleRootTop.children[1];var SvgChartTitle=document.createElementNS(SVGCandleChart.SVG_NS,"text");SvgChartTitle.setAttributeNS(null,"x","0");SvgChartTitle.setAttributeNS(null,"y","0");SvgChartTitle.setAttributeNS(null,"dominant-baseline","hanging");SvgChartTitle.setAttributeNS(null,"font-size","1.3em");SvgChartTitle.innerHTML=exchange+" : "+security;this.SvgCandleRoot.appendChild(SvgChartTitle);this.Socket=new SVGServerComs(this.SERVER_IP,this.onsocketready.bind(this),this.onfullchartreceived.bind(this),this.onlatestcandlereceived.bind(this),this.onanalysisreceived.bind(this))}SVGCandleChart.prototype.onfullchartreceived=function(cht){this.TotalCandlesServerReceived=cht.chart.length;var cndIdx=0;if(this.TotalCandlesServerReceived>=this.WantedNumberOfCandles){cndIdx=this.TotalCandlesServerReceived-this.WantedNumberOfCandles}var idxOffset=cndIdx;cndIdx=0;this.computePriceTransformations(cht,idxOffset);for(cndIdx;cndIdx<cht.chart.length;++cndIdx){var curCnd=cht.chart[cndIdx].candle;this.CandleDomReferences.push(new SVGCandleStick(this,curCnd,cndIdx-idxOffset))}this.createPriceTicksPlaceHolder();if(!this.Socket.getAnalysisData(this.InputExchange,this.InputSecurity)){console.error("unable to get analysis data")}};SVGCandleChart.prototype.onanalysisreceived=function(anl){for(var i=this.NumberOfCandlePatternsDrawn;i<anl.analysis.singleCandle.length;++i){this.CandleDomReferences[i].putSingleCandleAnalysis(anl.analysis.singleCandle[i]);this.CandleDomReferences[i].putDoubleCandleAnalysis(anl.analysis.doubleCandle[i])}this.NumberOfCandlePatternsDrawn=anl.analysis.singleCandle.length-1;for(var i=this.NumberOfSlopedTrendsDrawn;i<anl.analysis.slopedLines.length;++i){this.CandleDomReferences[anl.analysis.slopedLines[i].e].putSlopedTrendLine(anl.analysis.slopedLines[i])}this.NumberOfSlopedTrendsDrawn=anl.analysis.slopedLines.length;for(var i=this.NumberOfHorizontalTrendsDrawn;i<anl.analysis.trendLines.length;++i){this.CandleDomReferences[anl.analysis.trendLines[i].e].putHorizontalTrendLine(anl.analysis.trendLines[i])}this.NumberOfHorizontalTrendsDrawn=anl.analysis.trendLines.length;if(!this.Socket.getLatestCandle(this.InputExchange,this.InputSecurity)){console.error("unable to send latest candle from analysis callback")}};SVGCandleChart.prototype.onlatestcandlereceived=function(cnd){var latestCandle=cnd.latestCandle.candle;var numReferences=this.CandleDomReferences.length;this.updatePriceTransformations(latestCandle);this.updatePriceTicksValues();if(!this.CandleDomReferences[numReferences-1].tryUpdate(latestCandle)){if(this.TotalCandlesServerReceived>=this.WantedNumberOfCandles){this.CandleDomReferences.forEach(function(value){value.shiftLeft()});this.CandleDomReferences.push(new SVGCandleStick(this,latestCandle,this.WantedNumberOfCandles-1));this.TotalCandlesServerReceived+=1}else{this.CandleDomReferences.push(new SVGCandleStick(this,latestCandle,this.TotalCandlesServerReceived));this.TotalCandlesServerReceived+=1}this.Socket.getAnalysisData(this.InputExchange,this.InputSecurity);return}this.Socket.getLatestCandle(this.InputExchange,this.InputSecurity)};SVGCandleChart.prototype.onsocketready=function(){if(!this.Socket.getFullChart(this.InputExchange,this.InputSecurity)){console.error("unable to request full chart")}};SVGCandleChart.prototype.getPriceTransformation=function(){return this.PriceTransformation};SVGCandleChart.prototype.computePriceTransformations=function(cht,cndIdx){var maxPrice=Number.NEGATIVE_INFINITY;var minPrice=Number.POSITIVE_INFINITY;for(var i=cndIdx;i<cht.chart.length;++i){if(cht.chart[i].candle.h>maxPrice)maxPrice=cht.chart[i].candle.h;if(cht.chart[i].candle.l<minPrice)minPrice=cht.chart[i].candle.l}this.PriceTransformation=new LinearEquation(minPrice,1080,maxPrice,27.2);this.PixelTransformation=new LinearEquation(1080,minPrice,27.2,maxPrice)};SVGCandleChart.prototype.updatePriceTransformations=function(cnd){var maxPrice=Number.NEGATIVE_INFINITY;var minPrice=Number.POSITIVE_INFINITY;var cndIdx=0;if(this.TotalCandlesServerReceived>=this.WantedNumberOfCandles){cndIdx=this.TotalCandlesServerReceived-this.WantedNumberOfCandles}for(var i=cndIdx;i<this.CandleDomReferences.length;++i){if(this.CandleDomReferences[i].RawCandle.h>maxPrice){maxPrice=this.CandleDomReferences[i].RawCandle.h}if(this.CandleDomReferences[i].RawCandle.l<minPrice){minPrice=this.CandleDomReferences[i].RawCandle.l}}if(cnd.h>maxPrice)maxPrice=cnd.h;if(cnd.l<minPrice)minPrice=cnd.l;if(maxPrice!=this.PriceTransformation.x2||minPrice!=this.PriceTransformation.x1){this.PriceTransformation=new LinearEquation(minPrice,1080,maxPrice,27.2);this.PixelTransformation=new LinearEquation(1080,minPrice,27.2,maxPrice);this.CandleDomReferences.forEach(function(value){value.forceUpdate()})}};SVGCandleChart.prototype.getSVGCandlesDom=function(){return this.SvgCandleRoot};SVGCandleChart.prototype.createPriceTicksPlaceHolder=function(){for(var i=1;i<this.ChartStyleNumTicks;++i){var yoffset=i*(1080/this.ChartStyleNumTicks);var yAxisText=document.createElementNS(SVGCandleChart.SVG_NS,"text");yAxisText.setAttributeNS(null,"x","2010");yAxisText.setAttributeNS(null,"y",yoffset.toString());yAxisText.setAttributeNS(null,"font-size","1.3em");yAxisText.setAttributeNS(null,"text-rendering","optimizeLegibility");yAxisText.setAttributeNS(null,"dominant-baseline","middle");yAxisText.innerHTML=(this.PixelTransformation.eval(yoffset)/1e5).toFixed(5);this.TickPriceDomReferences.push(yAxisText);this.SvgYAxisRoot.appendChild(yAxisText);var yAxisTextLine=document.createElementNS(SVGCandleChart.SVG_NS,"line");yAxisTextLine.setAttributeNS(null,"x1","2005");yAxisTextLine.setAttributeNS(null,"x2","2010");yAxisTextLine.setAttributeNS(null,"y1",yoffset.toString());yAxisTextLine.setAttributeNS(null,"y2",yoffset.toString());yAxisTextLine.setAttributeNS(null,"stroke","black");this.SvgYAxisRoot.appendChild(yAxisTextLine)}};SVGCandleChart.prototype.updatePriceTicksValues=function(){for(var i=1;i<this.ChartStyleNumTicks;++i){var yoffset=i*(1080/this.ChartStyleNumTicks);this.TickPriceDomReferences[i-1].innerHTML=(this.PixelTransformation.eval(yoffset)/1e5).toFixed(5)}};SVGCandleChart.prototype.getCandleWidth=function(){return this.CandleWidth};SVGCandleChart.SVG_NS="http://www.w3.org/2000/svg";return SVGCandleChart}();window.onload=function(){new SVGCandleChart(0,"OANDA","EUR_USD");new SVGCandleChart(1,"OANDA","USD_JPY");new SVGCandleChart(2,"OANDA","AUD_CAD");new SVGCandleChart(3,"OANDA","USD_CAD")};var SVGServerComs=function(){function SVGServerComs(ip,onsocketready,onfullchartreceived,onlatestcandlereceived,onanalysisreceived){this.socket=new WebSocket(ip,"lws-minimal");this.onsocketready=onsocketready;this.onfullchartreceived=onfullchartreceived;this.onlatestcandlereceived=onlatestcandlereceived;this.onanalysisreceived=onanalysisreceived;this.socket.onmessage=this.onmessage.bind(this);this.socket.onopen=this.onopen.bind(this);this.socket.onclose=this.onclose.bind(this);this.socket.onerror=this.onerror.bind(this)}SVGServerComs.prototype.getFullChart=function(exchange,security){if(this.socket.readyState!=this.socket.OPEN){return false}else{this.socket.send("init|"+exchange+":"+security);return true}};SVGServerComs.prototype.getAnalysisData=function(exchange,security){if(this.socket.readyState!=this.socket.OPEN){return false}else{this.socket.send("analysis|"+exchange+":"+security);return true}};SVGServerComs.prototype.getLatestCandle=function(exchange,security){if(this.socket.readyState!=this.socket.OPEN){return false}else{this.socket.send("latest|"+exchange+":"+security);return true}};SVGServerComs.prototype.onmessage=function(evt){var response=JSON.parse(evt.data);if(response["chart"]!==undefined){this.onfullchartreceived(response)}else if(response["latestCandle"]){this.onlatestcandlereceived(response)}else if(response["analysis"]){this.onanalysisreceived(response)}};SVGServerComs.prototype.onopen=function(evt){console.log("websocket opened");this.onsocketready()};SVGServerComs.prototype.onclose=function(evt){console.log("websocket closed")};SVGServerComs.prototype.onerror=function(evt){console.error(evt)};return SVGServerComs}();