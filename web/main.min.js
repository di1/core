"use strict";var largeDisplayChart=null;var searchSocket=null;function searchInputKeyPress(evt){var searchInput=evt.srcElement;console.log(searchInput);var wantedStock=searchInput.value.toUpperCase();console.log(wantedStock);if(searchSocket&&wantedStock!==""){searchSocket.send("search|"+wantedStock)}if(evt.keyCode!=13){return}console.log(wantedStock);if(!largeDisplayChart){console.error("display chart is undefined");return}largeDisplayChart.setSymbol(wantedStock)}function onSearchReceived(evt){console.log("search results: "+evt.data)}window.onload=function(){searchSocket=new WebSocket("ws://riski.local:7681","lws-minimal");searchSocket.onmessage=onSearchReceived;largeDisplayChart=new CandleChart("AAPL");var searchInput=document.getElementById("stock-search-input");if(!searchInput){console.error("can't find search input");return}searchInput.onkeyup=searchInputKeyPress};var CandleChart=function(){function CandleChart(symbol){this.NUM_TICKS=20;this.PADDING_BOT=50;this.PADDING_TOP=20;this.CANDLE_WIDTH=10;this.CANDLE_UPDATES_SENT=0;this.CANDLE_SPACING=5;this.MOUSE_X=0;this.MOUSE_Y=0;this.RESET_CHART=false;this.CHART_STYLE_BACKGROUND_COLOR="#131722";this.CHART_STYLE_CANDLE_FALLING="#EF5350";this.CHART_STYLE_CANDLE_RISING="#26A69A";this.chartCanvas=document.getElementById("chart");this.symbol=symbol;this.conn=new WebSocket("ws://riski.local:7681","lws-minimal");this.conn.onopen=this.onOpen.bind(this);this.conn.onclose=this.onClose.bind(this);this.conn.onmessage=this.onMessage.bind(this);this.chartCanvas.onwheel=this.onMouseWheelEvent.bind(this);this.chartCanvas.onmousemove=this.onMouseMove.bind(this);this.ROOT_CHART={chart:[]};this.ANALYSIS_RESULTS={analysis:{singleCandle:[],trendLines:[]}}}CandleChart.prototype.resetChart=function(){this.ROOT_CHART={chart:[]};this.ANALYSIS_RESULTS={analysis:{singleCandle:[],trendLines:[]}}};CandleChart.prototype.setSymbol=function(symbol){this.symbol=symbol;this.RESET_CHART=true};CandleChart.prototype.onMessage=function(evt){if(this.RESET_CHART){this.RESET_CHART=false;this.resetChart();this.conn.send("init|"+this.symbol);return}var genericMsg=JSON.parse(evt.data);if(genericMsg["chart"]){var latestChart=genericMsg;if(!latestChart){console.error("onMessage latestChart == undefined");return}this.ROOT_CHART=latestChart;this.drawFull(this.ROOT_CHART)}else if(genericMsg["latestCandle"]){var updateCandle=genericMsg;if(!updateCandle){console.error("onMessage updateCandle == undefined");return}if(!this.ROOT_CHART){console.error("onMessage updateCandle happened before init");return}if(this.ROOT_CHART.chart[this.ROOT_CHART.chart.length-1].candle.s==updateCandle.latestCandle.candle.s){this.ROOT_CHART.chart[this.ROOT_CHART.chart.length-1].candle=updateCandle.latestCandle.candle;this.drawFull(this.ROOT_CHART)}else{this.ROOT_CHART.chart.push({candle:updateCandle.latestCandle.candle});this.conn.send("analysis|"+this.symbol);this.drawFull(this.ROOT_CHART)}}else if(genericMsg["analysis"]){this.ANALYSIS_RESULTS=genericMsg}else{console.error("invalid response from server")}};CandleChart.prototype.onOpen=function(evt){this.conn.send("init|"+this.symbol)};CandleChart.prototype.onClose=function(evt){console.log("websocket connection closed")};CandleChart.prototype.onMouseWheelEvent=function(evt){if(evt.deltaY>0){this.CANDLE_WIDTH+=1}if(evt.deltaY<0){this.CANDLE_WIDTH-=.5}};CandleChart.prototype.onMouseMove=function(evt){if(!this.chartCanvas){return}var rect=this.chartCanvas.getBoundingClientRect();var x=evt.clientX;var y=evt.clientY;var scaleX=this.chartCanvas.width/rect.width;var scaleY=this.chartCanvas.height/rect.height;this.MOUSE_X=(x-rect.left)*scaleX;this.MOUSE_Y=(y-rect.top)*scaleY};CandleChart.prototype.getChartRange=function(candles,startIndex){var gmax=Number.MIN_VALUE;var gmin=Number.MAX_VALUE;var vgmax=Number.MIN_VALUE;for(var i=startIndex;i<candles.length;++i){var lmax=Math.max(candles[i].candle.o,candles[i].candle.h,candles[i].candle.l,candles[i].candle.c);var lmin=Math.min(candles[i].candle.o,candles[i].candle.h,candles[i].candle.l,candles[i].candle.c);var vlmax=candles[i].candle.v;if(lmax>gmax){gmax=lmax}if(lmin<gmin){gmin=lmin}if(vlmax>vgmax){vgmax=vlmax}}var r={max:gmax,min:gmin,vmin:0,vmax:vgmax};return r};CandleChart.prototype.getPriceWidth=function(ctx){return ctx.measureText(" 0000.0000").width};CandleChart.prototype.canvasRenderContex2DSetup=function(ctx){ctx.canvas.width=window.innerWidth;ctx.canvas.height=window.innerHeight;ctx.translate(.5,.5);ctx.font="normal 1.4em Hack";ctx.textBaseline="middle";ctx.strokeStyle="white";ctx.fillStyle="white";ctx.save();ctx.fillStyle=this.CHART_STYLE_BACKGROUND_COLOR;ctx.fillRect(0,0,this.chartCanvas.width,this.chartCanvas.height);ctx.restore()};CandleChart.prototype.computeNumDisplayableCandles=function(ctx,rightBarPriceWidth){var numDisplayableCandles=(this.chartCanvas.width-rightBarPriceWidth)/(this.CANDLE_WIDTH+this.CANDLE_SPACING);numDisplayableCandles-=1;return numDisplayableCandles};CandleChart.prototype.computeCandleStartIndex=function(candles,maxDrawableCandles){var startIndex;if(maxDrawableCandles<candles.length){startIndex=Math.floor(candles.length-maxDrawableCandles)}else{startIndex=0}return startIndex};CandleChart.prototype.drawRightPriceBar=function(ctx,drawingWidth,rightBarPriceWidth,priceRange,priceToPixel){ctx.save();ctx.translate(drawingWidth-rightBarPriceWidth,0);ctx.lineWidth=.5;ctx.beginPath();ctx.moveTo(0,0);ctx.lineTo(0,this.chartCanvas.height);ctx.stroke();ctx.setLineDash([2,10]);var inc=(priceRange.max-priceRange.min)/this.NUM_TICKS;for(var i=priceRange.min;i<=priceRange.max;i+=inc){ctx.fillText("-"+(i/1e4).toFixed(4),0,priceToPixel.eval(i));ctx.beginPath();ctx.setLineDash([2,10]);ctx.moveTo(-drawingWidth,priceToPixel.eval(i));ctx.lineTo(0,priceToPixel.eval(i));ctx.stroke()}ctx.restore()};CandleChart.prototype.drawCandle=function(ctx,offset,draw,candle,priceToPixel){ctx.save();var y=candle.o>=candle.c?priceToPixel.eval(candle.o):priceToPixel.eval(candle.c);var highToY=priceToPixel.eval(candle.h)-y;var h=Math.abs(priceToPixel.eval(candle.o)-priceToPixel.eval(candle.c));var lowToBottom=priceToPixel.eval(candle.l)-y;ctx.strokeStyle=candle.o>candle.c?this.CHART_STYLE_CANDLE_FALLING:this.CHART_STYLE_CANDLE_RISING;ctx.fillStyle=ctx.strokeStyle;ctx.translate(offset,y);ctx.beginPath();draw.apply(ctx,[0,0,this.CANDLE_WIDTH,h]);ctx.stroke();ctx.beginPath();ctx.moveTo(this.CANDLE_WIDTH/2,highToY);ctx.lineTo(this.CANDLE_WIDTH/2,0);ctx.moveTo(this.CANDLE_WIDTH/2,h);ctx.lineTo(this.CANDLE_WIDTH/2,lowToBottom);ctx.stroke();ctx.restore()};CandleChart.prototype.drawVolume=function(ctx,offset,candle,volumeToPixel){ctx.save();ctx.strokeStyle=candle.o>candle.c?this.CHART_STYLE_CANDLE_FALLING:this.CHART_STYLE_CANDLE_RISING;ctx.fillStyle=ctx.strokeStyle;ctx.translate(offset,volumeToPixel.eval(candle.v));ctx.beginPath();ctx.fillRect(0,0,this.CANDLE_WIDTH,volumeToPixel.eval(candle.v));ctx.stroke();ctx.stroke();ctx.restore()};CandleChart.prototype.drawSingleCandleAnalysis=function(ctx,widthOffset,priceToPixel,candle,analysisCode){if(analysisCode==0){return}ctx.save();ctx.textBaseline="top";ctx.fillStyle="white";ctx.font="normal "+(this.CANDLE_WIDTH*2).toString()+"px Hack";var candleId;switch(analysisCode){case 0:candleId="";break;case 1:case 2:candleId="M";break;case 3:case 4:candleId="S";break;case 5:case 6:case 7:candleId="D";break;default:console.error("i don't know this candle pattern");candleId="?";break}ctx.translate(widthOffset+this.CANDLE_WIDTH/2,priceToPixel.eval(candle.l));ctx.fillText(candleId,-(ctx.measureText(candleId).width/2),5);ctx.restore()};CandleChart.prototype.drawTrendLine=function(ctx,candles,priceToPixel,trendLine,startIndex,rightBarPriceWidth,drawingWidth){if(trendLine.s<startIndex){return}ctx.save();ctx.beginPath();var height=0;if(trendLine.d==0){height=priceToPixel.eval(candles[trendLine.e].candle.l);ctx.strokeStyle="yellow"}else if(trendLine.d==1){height=priceToPixel.eval(candles[trendLine.e].candle.h);ctx.strokeStyle="#6666ff"}else if(trendLine.d==2){height=priceToPixel.eval(candles[trendLine.e].candle.l);ctx.strokeStyle="white";ctx.setLineDash([5,5])}else if(trendLine.d==3){height=priceToPixel.eval(candles[trendLine.e].candle.h);ctx.setLineDash([5,5])}ctx.fillStyle=ctx.strokeStyle;ctx.lineWidth=2;var startingOffsetX=(trendLine.s-startIndex)*(this.CANDLE_WIDTH+this.CANDLE_SPACING);var endingOffset=(trendLine.e-trendLine.s)*(this.CANDLE_WIDTH+this.CANDLE_SPACING)+this.CANDLE_WIDTH;ctx.translate(startingOffsetX,height);ctx.moveTo(0,0);ctx.lineTo(endingOffset,0);ctx.moveTo(endingOffset-10*Math.cos(Math.PI/4),-10*Math.cos(Math.PI/4));ctx.lineTo(endingOffset,0);ctx.moveTo(endingOffset-10*Math.cos(Math.PI/4),10*Math.cos(Math.PI/4));ctx.lineTo(endingOffset,0);ctx.stroke();ctx.restore();if(trendLine.d<=1){ctx.save();ctx.textBaseline="middle";ctx.translate(-(drawingWidth-rightBarPriceWidth),height-22.4/2);ctx.beginPath();ctx.fillStyle=trendLine.d==0?"yellow":"#6666ff";var fillTextData=trendLine.d==0?candles[trendLine.e].candle.l:candles[trendLine.e].candle.h;var fillTextDataString=(fillTextData/1e4).toFixed(4);ctx.fillRect(0,0,rightBarPriceWidth,22.4);ctx.fillStyle=trendLine.d==0?"black":"white";ctx.fillText("-"+fillTextDataString,0,22.4/2+3);ctx.stroke();ctx.restore()}};CandleChart.prototype.drawChart=function(ctx,startIndex,candles,priceToPixel,volumeToPixel,drawingWidth,rightBarPriceWidth){ctx.save();var analysisData=this.ANALYSIS_RESULTS.analysis;for(var i=startIndex;i<candles.length;++i){var widthOffset=(i-startIndex)*(this.CANDLE_WIDTH+this.CANDLE_SPACING);var analysisCode=i<analysisData.singleCandle.length?analysisData.singleCandle[i]:0;this.drawCandle(ctx,widthOffset,analysisCode>0?ctx.strokeRect:ctx.fillRect,candles[i].candle,priceToPixel);this.drawSingleCandleAnalysis(ctx,widthOffset,priceToPixel,candles[i].candle,analysisCode);this.drawVolume(ctx,widthOffset,candles[i].candle,volumeToPixel)}for(var i=0;i<analysisData.trendLines.length;++i){var trendLine=analysisData.trendLines[i];this.drawTrendLine(ctx,candles,priceToPixel,trendLine,startIndex,drawingWidth,rightBarPriceWidth)}ctx.restore()};CandleChart.prototype.mouseToCandleIndex=function(startIndex,candles){var mouseCandleIndex=Math.floor(this.MOUSE_X/(this.CANDLE_WIDTH+this.CANDLE_SPACING));mouseCandleIndex+=startIndex;if(mouseCandleIndex>=candles.length){mouseCandleIndex=candles.length-1}return mouseCandleIndex};CandleChart.prototype.drawFull=function(chart){var ctx=this.chartCanvas.getContext("2d");this.canvasRenderContex2DSetup(ctx);var drawingWidth=this.chartCanvas.width;var drawingHeight=this.chartCanvas.height-this.PADDING_BOT;var rightBarPriceWidth=ctx.measureText(" 0000.0000").width;var candles=chart.chart;var numDisplayableCandles=this.computeNumDisplayableCandles(ctx,rightBarPriceWidth);var startIndex=this.computeCandleStartIndex(candles,numDisplayableCandles);var priceRange=this.getChartRange(candles,startIndex);var priceToPixel=new LinearEquation(priceRange.max,this.PADDING_TOP,priceRange.min,drawingHeight);var volumeToPixel=new LinearEquation(priceRange.vmin,this.chartCanvas.height,priceRange.vmax,drawingHeight);var mouseCandleIndex=this.mouseToCandleIndex(startIndex,candles);ctx.save();ctx.font=(this.PADDING_TOP+1).toString()+"px Hack";ctx.textBaseline="top";ctx.fillStyle="white";ctx.fillText(" O:"+(candles[mouseCandleIndex].candle.o/1e4).toFixed(4)+" H:"+(candles[mouseCandleIndex].candle.h/1e4).toFixed(4)+" L:"+(candles[mouseCandleIndex].candle.l/1e4).toFixed(4)+" C:"+(candles[mouseCandleIndex].candle.c/1e4).toFixed(4),ctx.measureText(this.symbol).width+this.PADDING_TOP+10,4);ctx.fillText(this.symbol.toUpperCase(),this.PADDING_TOP/2,4);ctx.restore();this.drawRightPriceBar(ctx,drawingWidth,rightBarPriceWidth,priceRange,priceToPixel);this.drawChart(ctx,startIndex,candles,priceToPixel,volumeToPixel,drawingWidth,rightBarPriceWidth);this.CANDLE_UPDATES_SENT+=1;if(this.CANDLE_UPDATES_SENT%100==0){this.CANDLE_UPDATES_SENT=0;this.conn.send("init|"+this.symbol)}else{this.conn.send("latest|"+this.symbol)}};return CandleChart}();var LinearEquation=function(){function LinearEquation(x1,y1,x2,y2){this.slope=(y2-y1)/(x2-x1);this.inter=y1-this.slope*x1}LinearEquation.prototype.eval=function(z){return this.slope*z+this.inter};return LinearEquation}();