"use strict";var largeDisplayChart=null;function searchInputKeyPress(evt){if(evt.keyCode!=13){return}var searchInput=evt.srcElement;var wantedStock=searchInput.value.toUpperCase();console.log(wantedStock);if(!largeDisplayChart){console.error("display chart is undefined");return}largeDisplayChart.setSymbol(wantedStock)}window.onload=function(){largeDisplayChart=new CandleChart("AAPL");var searchInput=document.getElementById("stock-search-input");if(!searchInput){console.error("can't find search input");return}searchInput.onkeypress=searchInputKeyPress};var CandleChart=function(){function CandleChart(symbol){this.NUM_TICKS=20;this.PADDING_BOT=50;this.PADDING_TOP=20;this.CANDLE_WIDTH=10;this.CANDLE_UPDATES_SENT=0;this.CANDLE_SPACING=5;this.MOUSE_X=0;this.MOUSE_Y=0;this.RESET_CHART=false;this.CHART_STYLE_BACKGROUND_COLOR="#131722";this.chartCanvas=document.getElementById("chart");this.symbol=symbol;this.conn=new WebSocket("ws://localhost:7681","lws-minimal");this.conn.onopen=this.onOpen.bind(this);this.conn.onclose=this.onClose.bind(this);this.conn.onmessage=this.onMessage.bind(this);this.chartCanvas.onwheel=this.onMouseWheelEvent.bind(this);this.chartCanvas.onmousemove=this.onMouseMove.bind(this);this.ROOT_CHART={chart:[]};this.ANALYSIS_RESULTS={analysis:{singleCandle:[],trendLines:[]}}}CandleChart.prototype.setSymbol=function(symbol){this.symbol=symbol;this.RESET_CHART=true};CandleChart.prototype.onMessage=function(evt){if(this.RESET_CHART){this.RESET_CHART=false;this.conn.send("init|"+this.symbol);return}var genericMsg=JSON.parse(evt.data);if(genericMsg["chart"]){var latestChart=genericMsg;if(!latestChart){console.error("onMessage latestChart == undefined");return}this.ROOT_CHART=latestChart;this.drawFull(this.ROOT_CHART)}else if(genericMsg["latestCandle"]){var updateCandle=genericMsg;if(!updateCandle){console.error("onMessage updateCandle == undefined");return}if(!this.ROOT_CHART){console.error("onMessage updateCandle happened before init");return}if(this.ROOT_CHART.chart[this.ROOT_CHART.chart.length-1].candle.s==updateCandle.latestCandle.candle.s){this.ROOT_CHART.chart[this.ROOT_CHART.chart.length-1].candle=updateCandle.latestCandle.candle;this.drawFull(this.ROOT_CHART)}else{this.ROOT_CHART.chart.push({candle:updateCandle.latestCandle.candle});this.conn.send("analysis|"+this.symbol);this.drawFull(this.ROOT_CHART)}}else if(genericMsg["analysis"]){this.ANALYSIS_RESULTS=genericMsg}else{console.error("invalid response from server")}};CandleChart.prototype.onOpen=function(evt){this.conn.send("init|"+this.symbol)};CandleChart.prototype.onClose=function(evt){console.log("websocket connection closed")};CandleChart.prototype.onMouseWheelEvent=function(evt){if(evt.deltaY>0){this.CANDLE_WIDTH+=1}if(evt.deltaY<0){this.CANDLE_WIDTH-=.5}};CandleChart.prototype.onMouseMove=function(evt){if(!this.chartCanvas){return}var rect=this.chartCanvas.getBoundingClientRect();var x=evt.clientX;var y=evt.clientY;var scaleX=this.chartCanvas.width/rect.width;var scaleY=this.chartCanvas.height/rect.height;this.MOUSE_X=(x-rect.left)*scaleX;this.MOUSE_Y=(y-rect.top)*scaleY};CandleChart.prototype.getChartRange=function(candles,startIndex){var gmax=Number.MIN_VALUE;var gmin=Number.MAX_VALUE;var vgmax=Number.MIN_VALUE;for(var i=startIndex;i<candles.length;++i){var lmax=Math.max(candles[i].candle.o,candles[i].candle.h,candles[i].candle.l,candles[i].candle.c);var lmin=Math.min(candles[i].candle.o,candles[i].candle.h,candles[i].candle.l,candles[i].candle.c);var vlmax=candles[i].candle.v;if(lmax>gmax){gmax=lmax}if(lmin<gmin){gmin=lmin}if(vlmax>vgmax){vgmax=vlmax}}var r={max:gmax,min:gmin,vmin:0,vmax:vgmax};return r};CandleChart.prototype.getPriceWidth=function(ctx){return ctx.measureText(" 0000.0000").width};CandleChart.prototype.canvasRenderContex2DSetup=function(ctx){ctx.canvas.width=window.innerWidth;ctx.canvas.height=window.innerHeight;ctx.translate(.5,.5);ctx.font="normal 1.4em Monospace";ctx.textBaseline="middle";ctx.strokeStyle="white";ctx.fillStyle="white";ctx.save();ctx.fillStyle=this.CHART_STYLE_BACKGROUND_COLOR;ctx.fillRect(0,0,this.chartCanvas.width,this.chartCanvas.height);ctx.restore()};CandleChart.prototype.computeNumDisplayableCandles=function(ctx,rightBarPriceWidth){var numDisplayableCandles=(this.chartCanvas.width-rightBarPriceWidth)/(this.CANDLE_WIDTH+this.CANDLE_SPACING);numDisplayableCandles-=1;return numDisplayableCandles};CandleChart.prototype.computeCandleStartIndex=function(candles,maxDrawableCandles){var startIndex;if(maxDrawableCandles<candles.length){startIndex=Math.floor(candles.length-maxDrawableCandles)}else{startIndex=0}return startIndex};CandleChart.prototype.drawRightPriceBar=function(ctx,drawingWidth,rightBarPriceWidth,priceRange,priceToPixel){ctx.save();ctx.translate(drawingWidth-rightBarPriceWidth,0);ctx.beginPath();ctx.moveTo(0,0);ctx.lineTo(0,this.chartCanvas.height);ctx.stroke();var inc=(priceRange.max-priceRange.min)/this.NUM_TICKS;for(var i=priceRange.min;i<=priceRange.max;i+=inc){ctx.fillText("-"+(i/1e4).toFixed(4),0,priceToPixel.eval(i))}ctx.restore()};CandleChart.prototype.drawFull=function(chart){var ctx=this.chartCanvas.getContext("2d");this.canvasRenderContex2DSetup(ctx);var drawingWidth=this.chartCanvas.width;var drawingHeight=this.chartCanvas.height-this.PADDING_BOT;var rightBarPriceWidth=ctx.measureText(" 0000.0000").width;var candles=chart.chart;var numDisplayableCandles=this.computeNumDisplayableCandles(ctx,rightBarPriceWidth);var startIndex=this.computeCandleStartIndex(candles,numDisplayableCandles);var priceRange=this.getChartRange(candles,startIndex);var pixelToPrice=new LinearEquation(this.PADDING_TOP,priceRange.max,drawingHeight-this.PADDING_BOT,priceRange.min);var priceToPixel=new LinearEquation(priceRange.max,this.PADDING_TOP,priceRange.min,drawingHeight);var volumeToPixel=new LinearEquation(priceRange.vmin,this.chartCanvas.height,priceRange.vmax,drawingHeight);this.drawRightPriceBar(ctx,drawingWidth,rightBarPriceWidth,priceRange,priceToPixel);var lastColor="";for(var i=startIndex;i<candles.length;++i){var widthOffset=(i-startIndex)*(this.CANDLE_WIDTH+this.CANDLE_SPACING);var hasAnalysis=false;if(this.ANALYSIS_RESULTS&&i<this.ANALYSIS_RESULTS.analysis.singleCandle.length&&this.ANALYSIS_RESULTS.analysis.singleCandle[i]!=0){hasAnalysis=true}if(candles[i].candle.o>candles[i].candle.c){ctx.fillStyle="#EF5350";ctx.strokeStyle=ctx.fillStyle;lastColor=ctx.fillStyle;if(hasAnalysis){ctx.strokeRect(widthOffset,priceToPixel.eval(candles[i].candle.c),this.CANDLE_WIDTH,priceToPixel.eval(candles[i].candle.o)-priceToPixel.eval(candles[i].candle.c))}else{ctx.fillRect(widthOffset,priceToPixel.eval(candles[i].candle.c),this.CANDLE_WIDTH,priceToPixel.eval(candles[i].candle.o)-priceToPixel.eval(candles[i].candle.c))}ctx.beginPath();ctx.moveTo(widthOffset+this.CANDLE_WIDTH/2,priceToPixel.eval(candles[i].candle.h));ctx.lineTo(widthOffset+this.CANDLE_WIDTH/2,priceToPixel.eval(candles[i].candle.o));ctx.moveTo(widthOffset+this.CANDLE_WIDTH/2,priceToPixel.eval(candles[i].candle.l));ctx.lineTo(widthOffset+this.CANDLE_WIDTH/2,priceToPixel.eval(candles[i].candle.c));ctx.stroke();ctx.beginPath();ctx.fillRect(widthOffset,volumeToPixel.eval(candles[i].candle.v),this.CANDLE_WIDTH,this.chartCanvas.height-volumeToPixel.eval(candles[i].candle.v));ctx.stroke();ctx.fillStyle="black"}else if(candles[i].candle.o<candles[i].candle.c){ctx.fillStyle="#26A69A";ctx.strokeStyle=ctx.fillStyle;lastColor=ctx.fillStyle;if(hasAnalysis){ctx.strokeRect(widthOffset,priceToPixel.eval(candles[i].candle.o),this.CANDLE_WIDTH,priceToPixel.eval(candles[i].candle.c)-priceToPixel.eval(candles[i].candle.o))}else{ctx.fillRect(widthOffset,priceToPixel.eval(candles[i].candle.o),this.CANDLE_WIDTH,priceToPixel.eval(candles[i].candle.c)-priceToPixel.eval(candles[i].candle.o))}ctx.beginPath();ctx.moveTo(widthOffset+this.CANDLE_WIDTH/2,priceToPixel.eval(candles[i].candle.h));ctx.lineTo(widthOffset+this.CANDLE_WIDTH/2,priceToPixel.eval(candles[i].candle.c));ctx.moveTo(widthOffset+this.CANDLE_WIDTH/2,priceToPixel.eval(candles[i].candle.l));ctx.lineTo(widthOffset+this.CANDLE_WIDTH/2,priceToPixel.eval(candles[i].candle.o));ctx.stroke();ctx.beginPath();ctx.fillRect(widthOffset,volumeToPixel.eval(candles[i].candle.v),this.CANDLE_WIDTH,this.chartCanvas.height-volumeToPixel.eval(candles[i].candle.v));ctx.stroke();ctx.fillStyle="black"}else{if(candles[i].candle.v!=0){ctx.fillStyle="white";ctx.strokeStyle="white";ctx.beginPath();ctx.moveTo(widthOffset,priceToPixel.eval(candles[i].candle.o));ctx.lineTo(widthOffset+this.CANDLE_WIDTH,priceToPixel.eval(candles[i].candle.c));ctx.stroke();ctx.beginPath();ctx.moveTo(widthOffset+this.CANDLE_WIDTH/2,priceToPixel.eval(candles[i].candle.h));ctx.lineTo(widthOffset+this.CANDLE_WIDTH/2,priceToPixel.eval(candles[i].candle.c));ctx.moveTo(widthOffset+this.CANDLE_WIDTH/2,priceToPixel.eval(candles[i].candle.l));ctx.lineTo(widthOffset+this.CANDLE_WIDTH/2,priceToPixel.eval(candles[i].candle.o));ctx.stroke();ctx.beginPath();ctx.fillRect(widthOffset,volumeToPixel.eval(candles[i].candle.v),this.CANDLE_WIDTH,this.chartCanvas.height-volumeToPixel.eval(candles[i].candle.v));ctx.stroke()}}if(this.ANALYSIS_RESULTS!=undefined&&i<this.ANALYSIS_RESULTS.analysis.singleCandle.length&&this.ANALYSIS_RESULTS.analysis.singleCandle[i]!=0){ctx.textBaseline="top";ctx.fillStyle="white";var candleCode=this.ANALYSIS_RESULTS.analysis.singleCandle[i];var candleId=void 0;switch(candleCode){case 0:candleId="";break;case 1:case 2:candleId="M";break;case 3:case 4:candleId="S";break;case 5:case 6:case 7:candleId="D";break;default:console.error("i don't know this candle pattern");candleId="X";break}ctx.font="normal "+(this.CANDLE_WIDTH*2).toString()+"px monospace";ctx.fillText(candleId,widthOffset+this.CANDLE_WIDTH/2-ctx.measureText(candleId).width/2,priceToPixel.eval(candles[i].candle.l)+5);ctx.textBaseline="middle";ctx.font="normal 1.4em Monospace"}}if(this.ANALYSIS_RESULTS!=undefined&&this.ANALYSIS_RESULTS.analysis.trendLines.length!=0){for(var i=0;i<this.ANALYSIS_RESULTS.analysis.trendLines.length;++i){var trend=this.ANALYSIS_RESULTS.analysis.trendLines[i];if(trend.s>=startIndex){ctx.beginPath();ctx.save();ctx.lineWidth=.5;ctx.strokeStyle="yellow";ctx.fillStyle="yellow";if(trend.d){ctx.moveTo((trend.s-startIndex)*(this.CANDLE_WIDTH+this.CANDLE_SPACING),priceToPixel.eval(candles[trend.e].candle.h));ctx.lineTo((trend.e-startIndex+1)*(this.CANDLE_WIDTH+this.CANDLE_SPACING),priceToPixel.eval(candles[trend.e].candle.h))}ctx.stroke();ctx.restore();ctx.strokeStyle="black"}}}ctx.fillStyle=lastColor;ctx.fillRect(drawingWidth-this.getPriceWidth(ctx),priceToPixel.eval(candles[candles.length-1].candle.c)-20/2,this.getPriceWidth(ctx),20);ctx.fillStyle="white";ctx.fillText("-"+(candles[candles.length-1].candle.c/1e4).toFixed(4),drawingWidth-this.getPriceWidth(ctx),priceToPixel.eval(candles[candles.length-1].candle.c));ctx.fillStyle="white";ctx.fillRect(drawingWidth-this.getPriceWidth(ctx),this.MOUSE_Y-20/2,this.getPriceWidth(ctx),20);ctx.fillStyle="black";ctx.fillText("-"+(pixelToPrice.eval(this.MOUSE_Y)/1e4).toFixed(4),drawingWidth-this.getPriceWidth(ctx),this.MOUSE_Y);ctx.font=(this.PADDING_TOP+1).toString()+"px Monospace";ctx.fillStyle="white";ctx.textBaseline="top";ctx.fillText(this.symbol.toUpperCase(),0,0);var mouseCandleIndex=Math.floor(this.MOUSE_X/(this.CANDLE_WIDTH+this.CANDLE_SPACING));mouseCandleIndex+=startIndex;if(!this.ROOT_CHART){console.error("this.ROOT_CHART undefined");return}if(mouseCandleIndex>=this.ROOT_CHART.chart.length){mouseCandleIndex=this.ROOT_CHART.chart.length-1}var hoveredCandle=this.ROOT_CHART.chart[mouseCandleIndex].candle;ctx.fillText(" O:"+(hoveredCandle.o/1e4).toFixed(4)+" H:"+(hoveredCandle.h/1e4).toFixed(4)+" L:"+(hoveredCandle.l/1e4).toFixed(4)+" C:"+(hoveredCandle.c/1e4).toFixed(4),ctx.measureText(this.symbol).width+this.PADDING_TOP,0);ctx.fillText(new Date(hoveredCandle.e/1e6).toDateString(),drawingWidth-ctx.measureText(new Date(hoveredCandle.e/1e6).toDateString()).width-this.getPriceWidth(ctx),0);this.CANDLE_UPDATES_SENT+=1;if(this.CANDLE_UPDATES_SENT%100==0){this.CANDLE_UPDATES_SENT=0;this.conn.send("init|"+this.symbol)}else{this.conn.send("latest|"+this.symbol)}};return CandleChart}();var LinearEquation=function(){function LinearEquation(x1,y1,x2,y2){this.slope=(y2-y1)/(x2-x1);this.inter=y1-this.slope*x1}LinearEquation.prototype.eval=function(z){return this.slope*z+this.inter};return LinearEquation}();