"use strict";var LinearEquation=function(){function LinearEquation(x1,y1,x2,y2){this.slope=(y2-y1)/(x2-x1);this.inter=y1-this.slope*x1}LinearEquation.prototype.eval=function(z){return this.slope*z+this.inter};return LinearEquation}();var SVGCandleStick=function(){function SVGCandleStick(cht,cnd,cndIdx){this.candleBody=null;this.candleWick=null;this.PriceTransformedCandle=cnd;this.rootChart=cht;this.RawCandle={o:cnd.o,h:cnd.h,l:cnd.l,c:cnd.c};this.performCandleTransformation();this.cndIdx=cndIdx;this.candleBody=this.buildCandleBody();this.candleWick=this.buildCandleWick();this.candleGroup=document.createElementNS(SVGCandleChart.SVG_NS,"g");if(this.candleWick){this.candleGroup.appendChild(this.candleWick)}else{console.error("this.candleWick === null")}if(this.candleBody){this.candleGroup.appendChild(this.candleBody)}else{console.error("this.candleBody === null")}cht.getSVGCandlesDom().appendChild(this.candleGroup)}SVGCandleStick.prototype.buildCandleBody=function(){var cb;var createdNewCandle=false;if(this.candleBody===null){cb=document.createElementNS(SVGCandleChart.SVG_NS,"rect");createdNewCandle=true}else{cb=this.candleBody}cb.setAttributeNS(null,"width","10px");if(this.PriceTransformedCandle.o>this.PriceTransformedCandle.c){cb.setAttributeNS(null,"height",(this.PriceTransformedCandle.o-this.PriceTransformedCandle.c).toString()+"px");cb.setAttributeNS(null,"y",this.PriceTransformedCandle.c.toString()+"px");cb.setAttributeNS(null,"fill","green")}else if(this.PriceTransformedCandle.o<this.PriceTransformedCandle.c){cb.setAttributeNS(null,"height",(this.PriceTransformedCandle.c-this.PriceTransformedCandle.o).toString()+"px");cb.setAttributeNS(null,"y",this.PriceTransformedCandle.o.toString()+"px");cb.setAttributeNS(null,"fill","red")}cb.setAttributeNS(null,"x",(this.cndIdx*10).toString()+"px");if(createdNewCandle){return cb}else{return null}};SVGCandleStick.prototype.buildCandleWick=function(){var cw;var createdNewWick=false;if(this.candleWick===null){cw=document.createElementNS(SVGCandleChart.SVG_NS,"line");createdNewWick=true}else{cw=this.candleWick}cw.setAttributeNS(null,"x1",(this.cndIdx*10+5).toString()+"px");cw.setAttributeNS(null,"y1",this.PriceTransformedCandle.h.toString());cw.setAttributeNS(null,"x2",(this.cndIdx*10+5).toString()+"px");cw.setAttributeNS(null,"y2",this.PriceTransformedCandle.l.toString());cw.setAttributeNS(null,"stroke","black");if(createdNewWick){return cw}else{return null}};SVGCandleStick.prototype.tryUpdate=function(latestCandle){if(latestCandle.s===this.PriceTransformedCandle.s){if(latestCandle.o===this.RawCandle.o&&latestCandle.h===this.RawCandle.h&&latestCandle.l===this.RawCandle.l&&latestCandle.c===this.RawCandle.c){return true}this.PriceTransformedCandle=latestCandle;this.RawCandle={o:latestCandle.o,h:latestCandle.h,l:latestCandle.l,c:latestCandle.c};this.performCandleTransformation();this.buildCandleBody();this.buildCandleWick();return true}else{return false}};SVGCandleStick.prototype.performCandleTransformation=function(){this.PriceTransformedCandle.o=this.rootChart.getPriceTransformation().eval(this.PriceTransformedCandle.o);this.PriceTransformedCandle.h=this.rootChart.getPriceTransformation().eval(this.PriceTransformedCandle.h);this.PriceTransformedCandle.l=this.rootChart.getPriceTransformation().eval(this.PriceTransformedCandle.l);this.PriceTransformedCandle.c=this.rootChart.getPriceTransformation().eval(this.PriceTransformedCandle.c)};SVGCandleStick.prototype.shiftLeft=function(){this.cndIdx-=1;this.buildCandleBody();this.buildCandleWick()};return SVGCandleStick}();var SVGCandleChart=function(){function SVGCandleChart(){this.SERVER_IP="ws://161.35.136.101:7681";this.PriceTransformation=new LinearEquation(0,0,0,0);this.PixelTransformation=new LinearEquation(0,0,0,0);this.ChartStyleNumTicks=20;this.TotalCandlesServerReceived=0;this.WantedNumberOfCandles=200;this.CandleDomReferences=[];this.SvgCandleRoot=document.getElementsByTagNameNS(SVGCandleChart.SVG_NS,"g")[0];this.SvgYAxisRoot=document.getElementsByTagNameNS(SVGCandleChart.SVG_NS,"g")[1];this.Socket=new SVGServerComs(this.SERVER_IP,this.onsocketready.bind(this),this.onfullchartreceived.bind(this),this.onlatestcandlereceived.bind(this))}SVGCandleChart.prototype.onfullchartreceived=function(cht){this.TotalCandlesServerReceived=cht.chart.length;var cndIdx=0;if(this.TotalCandlesServerReceived>=this.WantedNumberOfCandles){cndIdx=this.TotalCandlesServerReceived-this.WantedNumberOfCandles}var idxOffset=cndIdx;cndIdx=0;this.computePriceTransformations(cht,idxOffset);for(cndIdx;cndIdx<cht.chart.length;++cndIdx){var curCnd=cht.chart[cndIdx].candle;this.CandleDomReferences.push(new SVGCandleStick(this,curCnd,cndIdx-idxOffset))}this.createPriceTicksPlaceHolder();this.Socket.getLatestCandle("OANDA","EUR_USD")};SVGCandleChart.prototype.onlatestcandlereceived=function(cnd){var _this=this;var latestCandle=cnd.latestCandle.candle;var numReferences=this.CandleDomReferences.length;if(!this.CandleDomReferences[numReferences-1].tryUpdate(latestCandle)){if(this.TotalCandlesServerReceived>=this.WantedNumberOfCandles){this.CandleDomReferences.forEach(function(value){value.shiftLeft()});this.CandleDomReferences.push(new SVGCandleStick(this,latestCandle,this.WantedNumberOfCandles-1));this.TotalCandlesServerReceived+=1}else{this.CandleDomReferences.push(new SVGCandleStick(this,latestCandle,this.TotalCandlesServerReceived-1));this.TotalCandlesServerReceived+=1}}setTimeout(function(){_this.Socket.getLatestCandle("OANDA","EUR_USD")},0)};SVGCandleChart.prototype.onsocketready=function(){if(!this.Socket.getFullChart("OANDA","EUR_USD")){console.error("unable to request full chart")}};SVGCandleChart.prototype.getPriceTransformation=function(){return this.PriceTransformation};SVGCandleChart.prototype.computePriceTransformations=function(cht,cndIdx){var maxPrice=Number.NEGATIVE_INFINITY;var minPrice=Number.POSITIVE_INFINITY;for(var i=cndIdx;i<cht.chart.length;++i){if(cht.chart[i].candle.h>maxPrice)maxPrice=cht.chart[i].candle.h;if(cht.chart[i].candle.l<minPrice)minPrice=cht.chart[i].candle.l}this.PriceTransformation=new LinearEquation(minPrice,1080,maxPrice,0);this.PixelTransformation=new LinearEquation(1080,minPrice,0,maxPrice)};SVGCandleChart.prototype.getSVGCandlesDom=function(){return this.SvgCandleRoot};SVGCandleChart.prototype.createPriceTicksPlaceHolder=function(){for(var i=1;i<this.ChartStyleNumTicks;++i){var yoffset=i*(1080/this.ChartStyleNumTicks);var yAxisText=document.createElementNS(SVGCandleChart.SVG_NS,"text");yAxisText.setAttributeNS(null,"x","2010");yAxisText.setAttributeNS(null,"y",yoffset.toString());yAxisText.innerHTML=(this.PixelTransformation.eval(yoffset)/1e5).toFixed(5);this.SvgYAxisRoot.appendChild(yAxisText)}};SVGCandleChart.prototype.UpdatePriceTicksValues=function(){};SVGCandleChart.SVG_NS="http://www.w3.org/2000/svg";return SVGCandleChart}();window.onload=function(){new SVGCandleChart};var SVGServerComs=function(){function SVGServerComs(ip,onsocketready,onfullchartreceived,onlatestcandlereceived){this.socket=new WebSocket(ip,"lws-minimal");this.onsocketready=onsocketready;this.onfullchartreceived=onfullchartreceived;this.onlatestcandlereceived=onlatestcandlereceived;this.socket.onmessage=this.onmessage.bind(this);this.socket.onopen=this.onopen.bind(this);this.socket.onclose=this.onclose.bind(this);this.socket.onerror=this.onerror.bind(this)}SVGServerComs.prototype.getFullChart=function(exchange,security){if(this.socket.readyState!=this.socket.OPEN){return false}else{this.socket.send("init|"+exchange+":"+security);return true}};SVGServerComs.prototype.getLatestCandle=function(exchange,security){if(this.socket.readyState!=this.socket.OPEN){return false}else{this.socket.send("latest|"+exchange+":"+security);return true}};SVGServerComs.prototype.onmessage=function(evt){var response=JSON.parse(evt.data);if(response["chart"]!==undefined){this.onfullchartreceived(response)}else if(response["latestCandle"]){this.onlatestcandlereceived(response)}};SVGServerComs.prototype.onopen=function(evt){console.log("websocket opened");this.onsocketready()};SVGServerComs.prototype.onclose=function(evt){console.log("websocket closed")};SVGServerComs.prototype.onerror=function(evt){console.error(evt)};return SVGServerComs}();