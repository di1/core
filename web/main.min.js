"use strict";window.onload=function(){document.body.style.backgroundColor=DarkTheme.bg;document.body.style.color=DarkTheme.fg;document.body.style.margin="0";document.body.style.padding="0";document.body.style.width="100%";document.body.style.height="100%";document.body.style.position="absolute";document.body.style.top="0";document.body.style.left="0";document.body.style.fontFamily="'Inconsolata', monospace";new Chart("IEX","SPY",DarkTheme)};var ServerComs=function(){function ServerComs(ip,onsocketready,onfullchartreceived,onlatestcandlereceived,onanalysisreceived){this.socket=new WebSocket(ip,"lws-minimal");this.onsocketready=onsocketready;this.onfullchartreceived=onfullchartreceived;this.onlatestcandlereceived=onlatestcandlereceived;this.onanalysisreceived=onanalysisreceived;this.socket.onmessage=this.onmessage.bind(this);this.socket.onopen=this.onopen.bind(this);this.socket.onclose=this.onclose.bind(this);this.socket.onerror=this.onerror.bind(this)}ServerComs.prototype.getFullChart=function(exchange,security){if(this.socket.readyState!=this.socket.OPEN){return false}else{this.socket.send("init|"+exchange+":"+security);return true}};ServerComs.prototype.getAnalysisData=function(exchange,security){if(this.socket.readyState!=this.socket.OPEN){return false}else{this.socket.send("analysis|"+exchange+":"+security);return true}};ServerComs.prototype.getLatestCandle=function(exchange,security){if(this.socket.readyState!=this.socket.OPEN){return false}else{this.socket.send("latest|"+exchange+":"+security);return true}};ServerComs.prototype.onmessage=function(evt){var response=JSON.parse(evt.data);if(response["chart"]!==undefined){this.onfullchartreceived(response)}else if(response["latestCandle"]){this.onlatestcandlereceived(response)}else if(response["analysisFull"]){this.onanalysisreceived(response)}};ServerComs.prototype.onopen=function(evt){this.onsocketready()};ServerComs.prototype.onclose=function(evt){console.error("Socket Connection Closed ("+evt.code+")")};ServerComs.prototype.onerror=function(evt){console.error(evt)};return ServerComs}();var ChartCandleView=function(){function ChartCandleView(canvaselement,cht){var _this=this;this.HorizontalLineInterval=15;this.Precision=1e5;this.FixedCount=5;this.ForceRefresh=false;this.DisplayLatency=0;this.CanvasElement=canvaselement;this.Renderer=this.CanvasElement.getContext("2d");this.StartCandle=0;this.NumVisibleCandles=0;this.Width=0;this.CandleViewWidthOffset=68;this.Height=0;this.MaxCandleValue=0;this.MinCandleValue=0;this.CandleWidth=4;this.CandleSpacing=2;this.PixelRatio=window.devicePixelRatio;this.FullChartData=cht;this.CanvasElement.onwheel=function(evt){if(evt.deltaY<0){_this.CandleWidth+=4;_this.CandleSpacing=_this.CandleWidth/2}else if(evt.deltaY>0&&_this.CandleWidth>4){_this.CandleWidth-=4;_this.CandleSpacing=_this.CandleWidth/2}_this.ForceRefresh=true};window.onresize=function(evt){_this.ForceRefresh=true};this.draw()}ChartCandleView.prototype.priceToText=function(price){return" "+(price/this.Precision).toFixed(this.FixedCount)};ChartCandleView.prototype.draw=function(){var frameBeginTime=Date.now();this.Renderer.save();var newWidth=this.CanvasElement.getBoundingClientRect().width;var newHeight=this.CanvasElement.getBoundingClientRect().height;this.Width=newWidth;this.Height=newHeight;this.Renderer.clearRect(0,0,this.Width,this.Height);this.CanvasElement.width=Math.floor(this.Width*this.PixelRatio);this.CanvasElement.height=Math.floor(this.Height*this.PixelRatio);this.Width-=this.CandleViewWidthOffset;this.Renderer.scale(this.PixelRatio,this.PixelRatio);var numberVisibleCandles=Math.floor(this.Width/(this.CandleWidth+this.CandleSpacing));var lftCndIdx=0;if(numberVisibleCandles<this.FullChartData.chart.length){lftCndIdx=this.FullChartData.chart.length-numberVisibleCandles}this.drawHorizontalGrid();var _a=this.chartMinMax(lftCndIdx),pmin=_a[0],pmax=_a[1];var pt=new LinearEquation(pmax,0,pmin,this.Height);this.drawVerticalGrid(pt,pmin,pmax);this.drawCandles(pt,lftCndIdx);this.Renderer.restore();var frameEndTime=Date.now();this.DisplayLatency=frameEndTime-frameBeginTime;console.log("Display Latency: "+this.DisplayLatency+"ms")};ChartCandleView.prototype.chartPartialUpdate=function(cnd){var chtLgt=this.FullChartData.chart.length;var lstCnd=this.FullChartData.chart[chtLgt-1].candle;if(lstCnd.s==cnd.latestCandle.candle.s){if(this.ForceRefresh||(lstCnd.o!=cnd.latestCandle.candle.o||lstCnd.h!=cnd.latestCandle.candle.h||lstCnd.l!=cnd.latestCandle.candle.l||lstCnd.c!=cnd.latestCandle.candle.c)){this.FullChartData.chart[chtLgt-1].candle=cnd.latestCandle.candle;this.draw();this.ForceRefresh=false}return true}else{return false}};ChartCandleView.prototype.chartfullUpdate=function(cht){this.FullChartData=cht;this.draw()};ChartCandleView.prototype.chartMinMax=function(lftCndIdx){var gmin=Number.MAX_VALUE;var gmax=Number.MIN_VALUE;var chtLength=this.FullChartData.chart.length;for(var i=lftCndIdx;i<chtLength;++i){if(this.FullChartData.chart[i].candle.h>gmax){gmax=this.FullChartData.chart[i].candle.h}if(this.FullChartData.chart[i].candle.l<gmin){gmin=this.FullChartData.chart[i].candle.l}}return[gmin,gmax]};ChartCandleView.prototype.drawVerticalGrid=function(pt,pmin,pmax){this.Renderer.save();this.Renderer.strokeStyle="#B3B1AD";this.Renderer.fillStyle="#B3B1AD";this.Renderer.lineWidth=.3;this.Renderer.font="16px Inconsolata";this.Renderer.textBaseline="middle";var numTicks=20;var tickInc=(pmax-pmin)/numTicks;this.Renderer.beginPath();for(var i=pmin;i<=pmax;i+=tickInc){var ylvl=pt.eval(i);this.Renderer.moveTo(.5,ylvl+.5);this.Renderer.lineTo(this.Width+2.5,ylvl+.5);if(i==pmin){this.Renderer.textBaseline="bottom"}else if(i+tickInc>=pmax){this.Renderer.textBaseline="hanging"}else{this.Renderer.textBaseline="middle"}this.Renderer.textAlign="left";this.Renderer.fillText(this.priceToText(i),this.Width,ylvl+.5)}this.Renderer.stroke();this.Renderer.restore()};ChartCandleView.prototype.drawHorizontalGrid=function(){this.Renderer.save();this.Renderer.strokeStyle="#B3B1AD";this.Renderer.lineWidth=.3;this.Renderer.beginPath();for(var i=0;i<=this.Width;i+=(this.CandleWidth+this.CandleSpacing)*this.HorizontalLineInterval){this.Renderer.moveTo(i+.5,.5);this.Renderer.lineTo(i+.5,this.Height+.5)}this.Renderer.moveTo(this.Width+.5,.5);this.Renderer.lineTo(this.Width+.5,this.Height+.5);this.Renderer.stroke();this.Renderer.restore()};ChartCandleView.prototype.drawCandles=function(pt,lftCndIdx){this.Renderer.save();var chtLength=this.FullChartData.chart.length;var curCnd=null;for(var i=lftCndIdx;i<chtLength;++i){curCnd=this.FullChartData.chart[i].candle;var adjidx=i-lftCndIdx;this.Renderer.beginPath();var drawColor=curCnd.o>curCnd.c?"#FF3333":"#BAE67E";this.Renderer.strokeStyle=drawColor;this.Renderer.fillStyle=drawColor;var hght=curCnd.o>curCnd.c?pt.eval(curCnd.c)-pt.eval(curCnd.o):pt.eval(curCnd.o)-pt.eval(curCnd.c);var tl=curCnd.o>curCnd.c?pt.eval(curCnd.o):pt.eval(curCnd.c);var xoffset=adjidx*(this.CandleWidth+this.CandleSpacing)+this.CandleSpacing/2;if(curCnd.o!=curCnd.c){this.Renderer.fillRect(xoffset,tl,this.CandleWidth,hght)}else{this.Renderer.moveTo(xoffset,tl);this.Renderer.lineTo(xoffset+this.CandleWidth,tl)}this.Renderer.moveTo(xoffset+this.CandleWidth/2+.5,pt.eval(curCnd.h)+.5);this.Renderer.lineTo(xoffset+this.CandleWidth/2+.5,pt.eval(curCnd.l));this.Renderer.strokeStyle=drawColor;this.Renderer.stroke()}if(curCnd){var ylvl=pt.eval(curCnd.c);this.Renderer.fillRect(this.Width+2.5,ylvl-8,this.CandleViewWidthOffset,16);if(this.Renderer.fillStyle=="#FF3333"){this.Renderer.fillStyle="#3c3c3c"}else{this.Renderer.fillStyle="#481e81"}this.Renderer.textAlign="left";this.Renderer.textBaseline="middle";this.Renderer.font="16px Inconsolata";this.Renderer.fillText(this.priceToText(curCnd.c),this.Width,ylvl+.5)}this.Renderer.restore()};return ChartCandleView}();var Chart=function(){function Chart(exchange,symbol,theme){this.ChartCandleView=null;this.Exchange="IEX";this.Symbol="SPY";this.Server="ws://localhost:7681";this.Theme=theme;this.Exchange=exchange;this.Symbol=symbol;this.Container=document.createElement("div");this.Container.style.margin="10px";this.Container.style.width="calc(100% - 22px)";this.Container.style.height="calc(100% - 22px)";this.Container.style.border="1px solid "+this.Theme.ui;document.body.appendChild(this.Container);this.ChartOptions=document.createElement("div");this.ChartOptions.classList.add("chart-options");this.ChartOptions.style.float="left";this.ChartOptions.style.width="calc(100%)";this.ChartOptions.style.height="2em";this.ChartOptions.style.display="flex";this.Container.appendChild(this.ChartOptions);this.ChartOptionsSearchInput=document.createElement("input");this.ChartOptionsSearchInput.style.backgroundColor=this.Theme.bg;this.ChartOptionsSearchInput.style.color=this.Theme.fg;this.ChartOptionsSearchInput.style.border="none";this.ChartOptionsSearchInput.style.paddingLeft="1em";this.ChartOptionsSearchInput.value=this.Exchange+":"+this.Symbol;this.ChartOptions.appendChild(this.ChartOptionsSearchInput);this.ChartOptionsSearchIcon=document.createElement("object");this.ChartOptionsSearchIcon.data="img/icons/search-24px.svg";this.ChartOptionsSearchIcon.type="image/svg+xml";this.ChartOptionsSearchIcon.style.borderRight="1px solid var(--fg)";this.ChartOptionsSearchIcon.onload=function(evt){var svgicon=evt.srcElement.getSVGDocument();console.log(svgicon);if(svgicon){svgicon.querySelector("path").setAttributeNS(null,"fill","#B3B1AD")}};this.ChartOptions.appendChild(this.ChartOptionsSearchIcon);this.CandleChart=document.createElement("canvas");this.CandleChart.style.float="left";this.CandleChart.style.width="calc(100%)";this.CandleChart.style.height="calc(100% - 2em)";this.Container.appendChild(this.CandleChart);this.Socket=new ServerComs(this.Server,this.onsocketready.bind(this),this.onfullchartreceived.bind(this),this.onlatestcandlereceived.bind(this),this.analysisreceivedfunc.bind(this))}Chart.prototype.onsocketready=function(){console.log("Connected to ws://"+document.domain+":7681");this.Socket.getFullChart(this.Exchange,this.Symbol)};Chart.prototype.onfullchartreceived=function(cht){if(this.ChartCandleView){this.ChartCandleView.chartfullUpdate(cht)}else{this.ChartCandleView=new ChartCandleView(this.CandleChart,cht)}this.Socket.getLatestCandle(this.Exchange,this.Symbol)};Chart.prototype.onlatestcandlereceived=function(cnd){if(this.ChartCandleView){if(!this.ChartCandleView.chartPartialUpdate(cnd)){this.Socket.getAnalysisData(this.Exchange,this.Symbol)}else{this.Socket.getLatestCandle(this.Exchange,this.Symbol)}}};Chart.prototype.analysisreceivedfunc=function(anl){console.log(anl);console.log(typeof anl);this.Socket.getFullChart(this.Exchange,this.Symbol);console.log("?")};return Chart}();var LinearEquation=function(){function LinearEquation(x1,y1,x2,y2){this.slope=(y2-y1)/(x2-x1);this.inter=y1-this.slope*x1;this.x1=x1;this.y1=y1;this.x2=x2;this.y2=y2}LinearEquation.prototype.eval=function(z){return this.slope*z+this.inter};return LinearEquation}();var DarkTheme={accent:"#E6B450",bg:"#0A0E14",fg:"#B3B1AD",ui:"#3D424D",tag:"#5CCFE6",func:"#FFD580",entity:"#73D0FF",string:"#BAE67E",regexp:"#95E6CB",markup:"#F28779",keyword:"#FFA759",special:"#FFE6B3",comment:"#5C6773",constant:"#D4BFFF",operator:"#F29E74",error:"#FF3333"};